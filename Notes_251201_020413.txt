import os
import logging
from telegram import Update
from telegram.ext import ApplicationBuilder, MessageHandler, filters, ContextTypes
from openai import OpenAI

logging.basicConfig(level=logging.INFO)

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")

async def handle_voice(update: Update, context: ContextTypes.DEFAULT_TYPE):
    file = await update.message.voice.get_file()
    file_path = "input.ogg"
    await file.download_to_drive(file_path)

    audio_file = open(file_path, "rb")

    transcript = client.audio.transcriptions.create(
        file=audio_file,
        model="gpt-4o-transcribe"
    )

    text_fa = transcript.text

    ai_response = client.responses.create(
        model="gpt-4.1",
        input=f"Translate this into very simple English suitable for a 1-year-old child: {text_fa}"
    )

    english_text = ai_response.output_text

    speech_file = "output.mp3"
    with open(speech_file, "wb") as f:
        result = client.audio.speech.create(
            model="gpt-4o-mini-tts",
            voice="verse",
            input=english_text
        )
        f.write(result)

    await update.message.reply_text(f"English: {english_text}")
    await update.message.reply_voice(voice=open(speech_file, "rb"))

async def main():
    app = ApplicationBuilder().token(TELEGRAM_TOKEN).build()
    app.add_handler(MessageHandler(filters.VOICE, handle_voice))
    await app.run_polling()

if __name__ == "__main__":
    import asyncio
    asyncio.run(main())